---
name: plan
description: 用于初始化与修订单文件 `001-{需求名}.md`（仅包含 `Requirements` / `Design` / `Tasks`，其中 `Design` 内包含 `Specs` 章节），并对产物进行自评与迭代；同时支持按 Phase 粒度执行，由 AI Agent 自行选择该 Phase 下应执行的 Story/Task。
version: 0.0.1
---

# Plan - 工作计划

## Workflows

{维护约定：各部分的结构与口径以 `references/` 下的 `template-xxx.md` 为准；若后续需要调整标准，应直接修改对应的 `template-xxx.md`，避免在 how-to/example/COMMAND 中复制出多份规则导致口径漂移。}

### 1. 初始化 / 修订

- 初始化：基于输入的 Requirements/Design/约束，初始化单文件 `001-{需求名}.md` 的三个段落（`Requirements` / `Design` / `Tasks`），其中 `Design` 段落内包含 `Specs` 章节。
- 修订：当用户提出新信息/反馈，或希望进一步调整目标与拆分时，基于同一份单文件对 `Requirements` / `Design` / `Tasks` 做增量修改；以最新内容为准，不维护历史版本。
- 联动原则：修订不是 `Requirements → Design → Tasks` 的单向过程，而是三者的往复联动；当用户在任一部分（尤其在 Tasks 执行中）形成了新决策或已有实现时，AI 必须基于该事实反向补全其余两部分，并保持整份文档的一致性、可执行性与有效性。
- 实践优先：若代码实现已体现明确决策（行为、边界、约束、接口），应以代码事实为准反推并修订 `Requirements` 与 `Design`；除非用户明确要求，不应保留与当前实现冲突的历史口径。

输入（用户至少提供，越完整越好）：

- Requirements：目标、范围、约束、验收标准
- Design：可落地的设计信息（其中包含 `Specs` 章节；`Specs` 的默认格式以 `template-design.md` 为准：`SPEC-xxx` 列表 + 验收 checkbox；后续可迭代优化）
- 限制条件：时间/人力/必须遵循的规范

输出：

- 单个文件：`001-{需求名}.md`
- 文件内部包含：`Requirements` / `Design` / `Tasks`（其中 `Design` 内包含 `Specs` 章节）

如果输入不足以完成初始化/修订，你只能指出缺口并向用户索要最小必要信息，再开始。

拆分循环（拆分 → 自评 → 反馈 → 迭代）：

1. **收集输入**：Requirements + Design + 约束
2. **执行拆分**：产出单文件 `001-{需求名}.md`
3. **自评打分**：对该单文件按 0-100 打分，输出扣分项与最小修改建议
4. **用户确认**：询问用户是否接受该评分口径与阈值（一般 60）
5. **分支**：
   - 若 **≥60 且用户接受**：结束
   - 若 **<60 或用户不接受**：回到第 2 步继续拆分，并在下一轮重新打分

### 2. Execute Phase（只到 Phase 粒度）

- 用户的执行指令只会到 Phase 粒度（例如“执行第一阶段”）。
- AI Agent 需要在该 Phase 下，自行判断应执行哪些 Story/Task（按从上到下的自然顺序为默认），并在发现异常依赖/阻塞时提示并停下等待确认。

## MUST Follow Rules

### Rule 1 - Core Principles

1. **先产出再评价**：必须先给出单文件产物（`Requirements` / `Design` / `Tasks`，且 `Design` 内包含 `Specs`），再依据标准自评打分；不要只讨论原则。
2. **结果导向**：关注是否“可执行、可验收、可追溯”，而不是拆分过程是否漂亮。
3. **粒度可控**：默认以“可落地且可验收”的最小形式输出，避免不必要的冗长。
4. **可验证优先**：自评必须落到可测试/可检查的标准（可复现、可度量、可对照）。
5. **循环改进**：若分数 < 60 或用户不接受结论，回到“怎么拆”继续迭代，而不是在原地争论。

补充约束：

 - **单文件交付**：最终产物只有一个 Markdown 文件（例如 `001-{需求名}.md`），文件内部包含 `Requirements` / `Design` / `Tasks` 三个段落（标题与结构以模板为准；其中 `Design` 内包含 `Specs` 章节）。
 - **初始化合并模板**：初始化 `001-{需求名}.md` 时，将 `references/` 下的多个模板片段（如 `template-requirements.md`、`template-design.md`、`template-tasks.md` 等）合并为单文件的对应段落；这些 `template-xxx.md` 是模板来源，应从中学习与复制结构，避免自行发明口径导致漂移。

### Rule 2 - 拼装规则（来源 / 过程 / 原则 / 输出目标）

本命令的核心工作不是“确认模板”，而是把来自多个参考文件的结构与口径**拼装**为单文件 `001-{需求名}.md`，并在修订时保持三段内容一致。

拼装来源（必须遵循其结构与口径）：

- `.commands/plan/references/template-requirements.md`
- `.commands/plan/references/template-design.md`
- `.commands/plan/references/template-tasks.md`

补充参考（需要时参考，但不作为强制模板）：

- 方法论：`.commands/plan/references/ears-format.md`
- 示例：`.commands/plan/references/001-example.md`

拼装过程（初始化 / 修订共用）：

1. 将上述 `template-xxx.md` 的段落结构合并到单文件中，确保只包含 `Requirements` / `Design` / `Tasks` 三个段落，且 `Design` 内包含 `Specs` 章节。
2. 将用户提供的信息落到对应段落；若用户只给了其中一段，也必须联动检查另外两段并做最小必要更新。
3. 若代码实现或执行中的决策已明确（行为、边界、约束、接口），以代码事实为准反推并修订 `Requirements` 与 `Design`，避免保留与实现冲突的历史口径。

拼装原则：

- 单一事实来源：所有结论都必须落回 `001-{需求名}.md`，不要在聊天里维护另一个版本。
- 最小必要变更：只改与新信息/新决策相关的最小范围，避免无关重写导致迭代发散。
- 一致性优先：任何一处修改都必须检查三段（R/S/T）是否仍对齐、是否可执行与可验收。

输出目标：

- 产出或更新单文件 `001-{需求名}.md`（唯一权威来源）。
- 让该文件达到“可执行、可验收、可追溯”的最低可用形态；不足之处通过 Tasks 明确下一步补齐。

### Rule 3 - Prohibited Behaviors

- 只给评分不给单文件产物。
- 评分项与建议无法映射到可操作的修改点（只输出主观感受）。
- 用户表示不接受评分口径后仍继续沿用，不做口径调整。
- 重写与目标无关的大段内容，导致迭代无法收敛。

### Rule 4 - Correct Flow Example

```
用户：我要做“功能 X”，这是 Requirements 与 Design（粘贴）。请你初始化/修订 Tasks。

你：
1) 先根据输入产出单文件 `001-{需求名}.md`（轻量默认）
2) 依据“期望的产物形式/粒度与评分标准”进行自评打分
3) 询问用户是否接受评分与阈值（通常 60）
4) 若 <60 或用户不接受 → 回到“怎么拆”迭代并重评分
```

## Single File Example（模板与评分标准）

**Single File of Truth（单一事实来源）**：`001-{需求名}.md` 是唯一权威来源。

- 任何讨论、迭代、评分与修改建议，都必须以该文件的当前内容为准。
- 不要在聊天里维护“另一个版本”的 Requirements/Design/Tasks；需要变更就直接反映到该文件结构对应段落里。

  最终只输出一个文件（示例文件名：`001-{需求名}.md`），其内容结构建议如下（段落标题大小写与 `template-xxx.md` 保持一致）：
  
 ```md
 # {需求名}
  
 ## Requirements
  
 ## Design
  
 ## Tasks
 ```

其中至少应覆盖：

{各个部分的结构与口径以 `references/` 下的 `template-xxx.md` 为准；若后续需要调整标准，应直接修改对应的 `template-xxx.md`，而不是在其它位置复制出另一份规则。}

  - **Requirements**：目标、范围、约束、验收标准
  - **Design**：可落地的设计信息（其中包含 `Specs` 章节；`Specs` 默认按 `SPEC-xxx` 列表 + 验收 checkbox 产出，必要时再细化）
  - **Tasks**：关键任务列表（每个任务写清“做什么、为什么、完成如何验收”）

### 评分标准（0-100，通常需 ≥60）

- **可执行性（0-30）**：任务能否直接被执行，完成定义是否明确
- **可验证性（0-25）**：验收/测试/证据是否明确
- **一致性与可追溯（0-20）**：Requirements/Design 与 Tasks 是否对齐、是否遗漏关键点
- **风险与依赖（0-15）**：风险/依赖是否识别到位且有应对
- **表达清晰（0-10）**：结构清楚、术语一致、读完能复述

评分输出必须给出扣分原因与可操作的修正点。
